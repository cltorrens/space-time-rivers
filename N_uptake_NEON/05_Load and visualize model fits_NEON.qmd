---
title: "Load and visualize fits for NEON NO3 models"
author: "Christa Torrens"
format: 
  html: 
    code-fold: true #enables collapsible code blocks
    code-summary: "Show the code"
editor: visual
execute:
    message: false
---

# Intro

This document uses rstan::extract and tidybayes to extract and visualize model fit params for the NEON data/ autotrohic uptake project

First created 2/25/2025 by Christa Torrens, with ongoing amendments

### Load needed libraries and model fits

```{r - load libraries}
#| warning: false
#| output: false

# Load libraries
library(tidyverse)
library(tidybayes)
library(bayesplot)
library(rstanarm)
library(here)
library(plotly)
library(sf)

```


### Plotting functions
This keeps all of the core plotting code in 1 place, and allows site-level customization (mostly dataframes and titles)
```{r - plotting functions}

##### Model fit - Npred + Nobs over time

plot_Nmodelfit_ts <- function(data, start_jday, end_jday, plot_title) {
  plot <- data %>%
    filter(model_jday >= start_jday & model_jday <= end_jday) %>%
    ggplot(aes(x = mod_hours)) +
    geom_point(aes(y = N_conc)) + 
    geom_line(aes(y = N_conc_pred), col = 'red') +
    labs(
      x = "Time (h)",
      y = expression("N" ~ (mmol ~ m^-3))
    ) +
    ggtitle(plot_title) +
    facet_wrap(~yr_jday) +
    theme_bw()
}

##### Model fit - Npred v Nobs w. 1:1 line

plot_Npred_v_Nobs <- function(data, plot_title) {
  plot <- ggplot(data=data, aes(x=N_conc, y=N_conc_pred)) +
  geom_point() + 
  labs( x=expression("measured N"~(mmol~m^-3)), # OR (mu*mol~L^-1)
        y=expression("modeled N"~(mmol~m^-3))  # ~ = a space, * = no space
      ) + 
  ggtitle(plot_title) +
  geom_abline(intercept = 0, slope = 1, color = "red") + 
  theme_bw()
}

##### Equifinality checks

## K vs U

plot_KvU <- function(data, plot_title) {
  plot <- ggplot(data=data, aes(y=K, x=U)) +
  geom_point() + 
  labs(y=expression("modeled K"~(d^-1)),
       x=expression("modeled U"~(mmol~m^-2~d^-1))
        ) + 
  ggtitle(plot_title) + 
  # geom_abline(intercept = 0, slope = 1, color = "red") + # doesn't show up - off the charts!
  theme_bw()

}
  

## K vs N_e

plot_KvNe <- function(data, plot_title) {
  plot <- ggplot(data=data, aes(y=K, x=N_e)) +
   geom_point() + 
   labs(y=expression("modeled K"~(d^-1)),
        x=expression("modeled N_e"~(mmol~m^-3)) 
        ) + 
   ggtitle(plot_title) + 
   # geom_abline(intercept = 0, slope = 1, color = "red") + # doesn't show up - off the charts!
  theme_bw()
}


## U vs N_e

plot_UvNe <- function(data, plot_title) {
  plot <- ggplot(data=data, aes(y=U, x=N_e)) +
   geom_point() + 
   labs(y=expression("modeled U"~(mmol~m^-2~d^-1)),
        x=expression("modeled N_e"~(mmol~m^-3)) 
        ) + 
   ggtitle(plot_title) + 
  theme_bw()
}


##### K over time

plot_K_ts <- function(data, plot_title) {
  plot <- ggplot(data=data, aes(x=d, y=K)) +
  geom_point() + 
  # geom_point(y = sumlight.real, color = 'gold') +
  labs( x= "Index", 
        y=expression("modeled K"~(d^-1)) # ~ = a space, * = no space
      ) + 
  ggtitle(plot_title) +
  theme_bw()
}

  
##### U over time

plot_U_ts <- function(data, plot_title) {
  ggplot(data=data, aes(x=d, y=U)) +
  geom_point() + 
  # geom_point(y = sumlight.real_wlou, color = 'gold') +
  # ADD IN HIGH AND LOW CIs
  labs( x= "Index", 
        y=expression("modeled U"~(mmol~m^-2~d^-1)) # ~ = a space, * = no space
      ) + 
  ggtitle(plot_title) +
  theme_bw()
}


##### U vs. real sumlight

plot_UvLight <- function(data, plot_title) {
  plot <- ggplot(data=data, aes(x=sumlightReal, y=U)) +
  geom_point() + 
  labs( x= "measured daily light (add units)", 
        y=expression("modeled U"~(mmol~m^-2~d^-1)) # ~ = a space, * = no space
      ) + 
  scale_x_log10() + scale_y_log10() + 
  ggtitle(plot_title) +
  theme_bw()
}


##### U + daily (or hourly?) sumlight over time



##### Autotrophic U vs total U

plot_autoUperc <- function(data, plot_title) {
  plot <- ggplot(data=data, aes(x=d, y=U_auto_perc)) +
  geom_point() + 
  xlab("Index") + ylab("Percent autotrophic uptake") + 
  ggtitle(plot_title) + 
  theme_bw()
}


```


### Load model fits and data by site (stored as RDS files), then extract parameters

```{r, error notes}
#| echo: false

# Hmmm: error notes when loading the rds files:
# 
# The legacy packages maptools, rgdal, and rgeos, underpinning the sp package, which was just loaded, will retire in October 2023. Please refer to R-spatial evolution reports for details, especially <https://r-spatial.org/r/2023/05/15/evolution4.html.> It may be desirable to make the sf package available; package maintainers should consider adding sf to Suggests:. The sp package is now running under evolution status 2 (status 2 uses the sf package in place of rgdal)

# I've added sf() to the library block

```


#### BIGC
Outputs and visualizations for Upper Big Creek, Fresno, CA 

###### Load model fits and data
```{r load BIGC model fit and data}
#| output: false
#| message: false

###### Load model fit __________________________________________________________

bigc.fit <- readRDS(here("N_uptake_NEON/data/model_fits/bigc.fit.rds"))

# if working from model run
# bigc.fit <- fit.bigc


###### Load model data ________________________________________________________

# data from model

bigc.modeldata <- readRDS(here("N_uptake_NEON/data/model_datalist/bigc.data.rds"))

###### Load dataset (includes datatime info, which model data does not) _______

# full dataset
path <- here("N_uptake_NEON/data/neon_data_clean/bigc_clean.csv")
bigc.df <- read_csv(path) %>%
  mutate(local_datetime = with_tz(local_datetime, tzone="US/Pacific"), 
         model_datetime = local_datetime - hours(4))  


# hourly dataset
path_h <- here("N_uptake_NEON/data/neon_data_clean/bigc_hourly_clean.csv")
bigc.df.h <- read_csv(path_h) %>%
  mutate(local_datetime = with_tz(local_datetime, tzone="US/Pacific"), 
         model_datetime = local_datetime - hours(4))  
  
  
```

###### Extract model parameters and real-data values

First, check the fit for sigmas and betas ("sigma", "sigma_U", "b0", "b1"), since these are notoriously tough to fit. Then put the spread and mean/ median/ quartile info for K, U, and N_e into a BIGC tibble (to be saved in one large csv at the end of the document). Finally, assemble tibbles for the visualizations, which include both modeled parameters and real data. 

```{r - bigc: extract model params and real-data values}
##| echo: false

# get list of variables for the model fit
# get_variables(bigc.fit) - too many to see all, but informs re: structure [hour,day] for hourly variables

###### Check the fit for sigmas and betas (tough to fit): ______________________
print(bigc.fit, pars=c("sigma", "sigma_U", "b0", "b1"))

###### Summarize daily variables (K, U, N_e) ___________________________________

# First, use spread_draws for the daily parameters - this gives each parameter its own column
# d = days (198), chain = 4, iteration = 1K, draw = 4K (1 per iteration per chain)
bigc.spread <- spread_draws(bigc.fit, K[d], U[d], N_e[d]) 


# Then get the mean/median + 95% QI (CI) for each parameter/day

### median + CI
bigc.medqi <- bigc.spread %>%
  # dplyr::group_by(d) %>%  # Unnecessary: tidybayes automatically groups by the selected spread_draws group [in this case, 'd']
  median_qi() %>%
  # summarise_draws() %>%
  # pivot_wider(names_from = variable, values_from = mean, median, sd, mad, q5, q95, rhat, ess_bulk, ess_tail) %>%
  add_column(site = "BIGC")

### mean + QI
bigc.meanqi <- bigc.spread %>%
  mean_qi() %>%
  add_column(site = "BIGC")

### Add median param info to the meanqi df
bigc.meanqi$K.median <- bigc.medqi$K
bigc.meanqi$U.median <- bigc.medqi$U
bigc.meanqi$N_e.median <- bigc.medqi$N_e


### Save the daily output + quantiles


### Summarize hourly variable (conc_pred)

bigc.spread.h <- spread_draws(bigc.fit, conc_pred[h,d])
# View(bigc.spread.h)


bigc.meanqi.h <- bigc.spread.h %>%
  dplyr::group_by(d, h) %>%  # This command IS needed here: tidybayes *did* have h + d column outputs, but the values were both different and less precise than when grouping by (d, h). 
  mean_qi() %>%
  add_column(site = "BIGC")


### Save the hourly output + quantiles


####### FROM REAL DATA --------------------------------------------

nday_bigc <- bigc.modeldata$D

concMA_bigc <- bigc.modeldata$concMA

# change no3 data from a matrix (concMA) w. column names V1, V2...V[nday] to a vector w. numeric day indices (1, 2, ...198).  Remove "V"?  

N_obs <- as.vector(concMA_bigc)

local_datetime_bigc <- bigc.df.h$local_datetime 
# local_date_bigc <- unique(date(bigc.df.h$local_datetime))  # not quite there w. extracting dates from the hourly data
# model_date_bigc <- bigc.df$model_datetime # nope, this is the FULL 15-min dataset 
model_datetime_bigc <- bigc.df.h$local_datetime - hours(4)
# model_jday_bigc <-bigc.df.h$model_jday
model_yrjday_bigc <- bigc.df.h$yr_jday  # hourly data
mod_yrjday_bigc <- unique(bigc.df.h$yr_jday) # daily data
# hours_bigc <- hour(local_datetime_bigc)
# mod_hours_bigc <- hour(model_datetime_bigc)


####### LOAD DEPTH #################################
zMA <- bigc.modeldata$zMA
#z.daily <- apply(zMA, MARGIN = 2, FUN = mean) ##this wouldn't knit in Quarto, IDK why not

####### LOAD REAL DAILY SUMLIGHT ###################
sumlight.real_bigc <- bigc.modeldata$sumlightReal
sumlight.ideal_bigc <- bigc.modeldata$sumlightIdeal

###################  Compile dataframes _________________________________________

####### Hourly dataframe: N and N_pred #############

N_output_bigc.df <- bigc.df.h %>%  # change to the medqi.h file! then add as needed
  select(local_datetime, model_datetime, surfWaterNitrateMean, GHI_wm2, Year, yr_jday, Jday, model_jday) %>%
  rename(N_conc = surfWaterNitrateMean, 
         realLight_wm2 = GHI_wm2) %>%
  mutate(hours = hour(local_datetime), 
         mod_hours = hour(model_datetime))
  
N_output_bigc.df$N_conc_pred <- bigc.meanqi.h$conc_pred
N_output_bigc.df$z <- as.vector(zMA) #average daily depth


####### Daily dataframe: U, K, N_e ##################

daily_output_bigc.df <- bigc.meanqi %>%
  add_column(sumlightReal = sumlight.real_bigc, 
             sumlightIdeal = sumlight.ideal_bigc, 
             z = colMeans(zMA), # daily depth = average of hourly depth
             yr_jday = mod_yrjday_bigc)  # the daily yr_jday object

mean(daily_output_bigc.df$K) # 3.225407
mean(daily_output_bigc.df$U) # 0.1986689
mean(daily_output_bigc.df$N_e) # 3.395281



```


###### Create visualizations - 

```{r - bigc: create visualizations}
#| echo: true

############  N Model fit to data _____________________________________________

######  N model fit over time - predicted N vs measured N  #######

N_Npred_ts_bigc <- plot_Nmodelfit_ts(data=N_output_bigc.df, start_jday = 35, end_jday = 60, plot_title = "NEON N data + model predictions: Upper Big Creek, CA")

#quartz(width=6,height=6)
N_Npred_ts_bigc


######  predicted N vs measured N + 1:1 line  #######

Npred_v_N_bigc <- plot_Npred_v_Nobs(data=N_output_bigc.df, plot_title="Measured N vs predicted N, Upper Big Creek, CA")

#quartz(width=6, height=6)
Npred_v_N_bigc


###### Equifinality checks __________________________________________________

####### Check equifinality!! K vs U

KvU_bigc <- plot_KvU(data=daily_output_bigc.df, plot_title = "Equifinality check, Upper Big Creek, CA: modeled K vs modeled U")
  
#quartz(width=7.5, height=6)
KvU_bigc
  

####### Check equifinality!! K vs N_e  

KvNe_bigc <- plot_KvNe(data=daily_output_bigc.df, plot_title = "Equifinality check, Upper Big Creek, CA: modeled K vs modeled equilibrium N")

#quartz(width=7.5, height=6)
KvNe_bigc


####### Check equifinality!! U vs N_e  

UvNe_bigc <- plot_UvNe(data=daily_output_bigc.df, plot_title = "Equifinality check, Upper Big Creek, CA: modeled U vs modeled equilibrium N")
 
#quartz(width=7.5, height=6)
UvNe_bigc


#######  Other parameter visualizations _________________________________________

#######  K over time

K_v_time_bigc <- plot_K_ts(data=daily_output_bigc.df, plot_title = "modeled K over time, Upper Big Creek, CA")

#quartz(width=6.5, height=6)
K_v_time_bigc


##### U over time

U_time_bigc <- plot_U_ts(data=daily_output_bigc.df, plot_title="Diel nitrate uptake (modeled), Upper Big Creek, CA")

#quartz(width=6, height=6)
U_time_bigc


###### U vs sumlight

U_vs_light_bigc <- plot_UvLight(data=daily_output_bigc.df, plot_title = "Scatterplot of NO3 uptake and daily light: Upper Big Creek, CA")

# quartz(width=6.5, height=6)
U_vs_light_bigc


```


###### Compare U_total and U_auto
What percentage of total uptake is the autotrophic uptake?

```{r - bigc: percent autotrophic NO3 uptake}

# NON-AUTOTROPHIC UPTAKE = Equilibrium nitrate * K
# TOTAL UPTAKE = U + (Equilibrium nitrate * K)  
# Since U_auto is very small, there won't be much difference between 'non-autotrophic uptake' and 'total uptake'

daily_output_bigc.df <- daily_output_bigc.df %>%
  mutate(U_het = N_e*K*z,      
         U_tot = U_het + U, 
         U_auto_perc = 100*U/U_tot)

U_auto_avg <- mean(daily_output_bigc.df$U_auto_perc) #10.3% on average

Uauto_perc_bigc <- plot_autoUperc(data=daily_output_bigc.df, plot_title = "Daily  autotrophic uptake (as % of total uptake), Upper Big Creek, CA")

# quartz()
Uauto_perc_bigc 

#### Interactive w. ggplotly, but only gives the x,y info... maybe if I added datetime-associated labels?
# ggplotly(Uauto_plot_bigc)

```



#### CARI
Outputs and visualizations for Caribou Creek, Fairbanks North Star, AK

###### Load model fits and data
```{r load CARI model fit and data}
#| output: false
#| message: false

###### Load model fit __________________________________________________________

cari.fit <- readRDS(here("N_uptake_NEON/data/model_fits/cari.fit.rds"))

# if working from model run
# cari.fit <- fit.cari


###### Load model data ________________________________________________________

# data from model

cari.modeldata <- readRDS(here("N_uptake_NEON/data/model_datalist/cari.data.rds"))

###### Load dataset (includes datatime info, which model data does not) _______

# full dataset
path <- here("N_uptake_NEON/data/neon_data_clean/cari_clean.csv")
cari.df <- read_csv(path) %>%
  mutate(local_datetime = with_tz(local_datetime, tzone="US/Pacific"), 
         model_datetime = local_datetime - hours(4))  


# hourly dataset
path_h <- here("N_uptake_NEON/data/neon_data_clean/cari_hourly_clean.csv")
cari.df.h <- read_csv(path_h) %>%
  mutate(local_datetime = with_tz(local_datetime, tzone="US/Pacific"), 
         model_datetime = local_datetime - hours(4))  
  
  
```

###### Extract model parameters and real-data values

First, check the fit for sigmas and betas ("sigma", "sigma_U", "b0", "b1"), since these are notoriously tough to fit. Then put the spread and mean/ median/ quartile info for K, U, and N_e into a CARI tibble (to be saved in one large csv at the end of the document). Finally, assemble tibbles for the visualizations, which include both modeled parameters and real data. 

```{r - cari: extract model params and real-data values}
##| echo: false

# get list of variables for the model fit
# get_variables(cari.fit) - too many to see all, but informs re: structure [hour,day] for hourly variables

###### Check the fit for sigmas and betas (tough to fit): ______________________
print(cari.fit, pars=c("sigma", "sigma_U", "b0", "b1"))

###### Summarize daily variables (K, U, N_e) ___________________________________

# First, use spread_draws for the daily parameters - this gives each parameter its own column
# d = days (198), chain = 4, iteration = 1K, draw = 4K (1 per iteration per chain)
cari.spread <- spread_draws(cari.fit, K[d], U[d], N_e[d]) 


# Then get the mean/median + 95% QI (CI) for each parameter/day

### median + CI
cari.medqi <- cari.spread %>%
  # dplyr::group_by(d) %>%  # Unnecessary: tidybayes automatically groups by the selected spread_draws group [in this case, 'd']
  median_qi() %>%
  # summarise_draws() %>%
  # pivot_wider(names_from = variable, values_from = mean, median, sd, mad, q5, q95, rhat, ess_bulk, ess_tail) %>%
  add_column(site = "CARI")

### mean + QI
cari.meanqi <- cari.spread %>%
  mean_qi() %>%
  add_column(site = "CARI")

### Add median param info to the meanqi df
cari.meanqi$K.median <- cari.medqi$K
cari.meanqi$U.median <- cari.medqi$U
cari.meanqi$N_e.median <- cari.medqi$N_e


### Save the daily output + quantiles


### Summarize hourly variable (conc_pred)

cari.spread.h <- spread_draws(cari.fit, conc_pred[h,d])
# View(cari.spread.h)


cari.meanqi.h <- cari.spread.h %>%
  dplyr::group_by(d, h) %>%  # This command IS needed here: tidybayes *did* have h + d column outputs, but the values were both different and less precise than when grouping by (d, h). 
  mean_qi() %>%
  add_column(site = "CARI")


### Save the hourly output + quantiles


####### FROM REAL DATA --------------------------------------------

nday_cari <- cari.modeldata$D

concMA_cari <- cari.modeldata$concMA

# change no3 data from a matrix (concMA) w. column names V1, V2...V[nday] to a vector w. numeric day indices (1, 2, ...198).  Remove "V"?  

N_obs <- as.vector(concMA_cari)

local_datetime_cari <- cari.df.h$local_datetime 
# local_date_cari <- unique(date(cari.df.h$local_datetime))  # not quite there w. extracting dates from the hourly data
# model_date_cari <- cari.df$model_datetime # nope, this is the FULL 15-min dataset 
model_datetime_cari <- cari.df.h$local_datetime - hours(4)
# model_jday_cari <-cari.df.h$model_jday
model_yrjday_cari <- cari.df.h$yr_jday  # hourly data
mod_yrjday_cari <- unique(cari.df.h$yr_jday) # daily data
# hours_cari <- hour(local_datetime_cari)
# mod_hours_cari <- hour(model_datetime_cari)


####### LOAD DEPTH #################################
zMA <- cari.modeldata$zMA
#z.daily <- apply(zMA, MARGIN = 2, FUN = mean) ##this wouldn't knit in Quarto, IDK why not

####### LOAD REAL DAILY SUMLIGHT ###################
sumlight.real_cari <- cari.modeldata$sumlightReal
sumlight.ideal_cari <- cari.modeldata$sumlightIdeal

###################  Compile dataframes _________________________________________

####### Hourly dataframe: N and N_pred #############

N_output_cari.df <- cari.df.h %>%  # change to the medqi.h file! then add as needed
  select(local_datetime, model_datetime, surfWaterNitrateMean, GHI_wm2, Year, yr_jday, Jday, model_jday) %>%
  rename(N_conc = surfWaterNitrateMean, 
         realLight_wm2 = GHI_wm2) %>%
  mutate(hours = hour(local_datetime), 
         mod_hours = hour(model_datetime))
  
N_output_cari.df$N_conc_pred <- cari.meanqi.h$conc_pred
N_output_cari.df$z <- as.vector(zMA) #average daily depth


####### Daily dataframe: U, K, N_e ##################

daily_output_cari.df <- cari.meanqi %>%
  add_column(sumlightReal = sumlight.real_cari, 
             sumlightIdeal = sumlight.ideal_cari, 
             z = colMeans(zMA), # daily depth = average of hourly depth
             yr_jday = mod_yrjday_cari)  # the daily yr_jday object

mean(daily_output_cari.df$K) # 3.225407
mean(daily_output_cari.df$U) # 0.1986689
mean(daily_output_cari.df$N_e) # 3.395281



```


###### Create visualizations - Caribou Creek, AK

```{r - cari: create visualizations}
#| echo: true

############  N Model fit to data _____________________________________________

######  N model fit over time - predicted N vs measured N  #######

N_Npred_ts_cari <- plot_Nmodelfit_ts(data=N_output_cari.df, start_jday = 35, end_jday = 60, plot_title = "NEON N data + model predictions: Caribou Creek, AK")

#quartz(width=6,height=6)
N_Npred_ts_cari


######  predicted N vs measured N + 1:1 line  #######

Npred_v_N_cari <- plot_Npred_v_Nobs(data=N_output_cari.df, plot_title="Measured N vs predicted N, Caribou Creek, AK")

#quartz(width=6, height=6)
Npred_v_N_cari


###### Equifinality checks __________________________________________________

####### Check equifinality!! K vs U

KvU_cari <- plot_KvU(data=daily_output_cari.df, plot_title = "Equifinality check, Caribou Creek, AK: modeled K vs modeled U")
  
#quartz(width=7.5, height=6)
KvU_cari
  

####### Check equifinality!! K vs N_e  

KvNe_cari <- plot_KvNe(data=daily_output_cari.df, plot_title = "Equifinality check, Caribou Creek, AK: modeled K vs modeled equilibrium N")

#quartz(width=7.5, height=6)
KvNe_cari


####### Check equifinality!! U vs N_e  

UvNe_cari <- plot_UvNe(data=daily_output_cari.df, plot_title = "Equifinality check, Caribou Creek, AK: modeled U vs modeled equilibrium N")
 
#quartz(width=7.5, height=6)
UvNe_cari


#######  Other parameter visualizations _________________________________________

#######  K over time

K_v_time_cari <- plot_K_ts(data=daily_output_cari.df, plot_title = "modeled K over time, Caribou Creek, AK")

#quartz(width=6.5, height=6)
K_v_time_cari


##### U over time

U_time_cari <- plot_U_ts(data=daily_output_cari.df, plot_title="Diel nitrate uptake (modeled), Caribou Creek, AK")

#quartz(width=6, height=6)
U_time_cari


###### U vs sumlight

U_vs_light_cari <- plot_UvLight(data=daily_output_cari.df, plot_title = "Scatterplot of NO3 uptake and daily light: Caribou Creek, AK")

# quartz(width=6.5, height=6)
U_vs_light_cari


```


###### Compare U_total and U_auto
What percentage of total uptake is the autotrophic uptake?

```{r - cari: percent autotrophic NO3 uptake}

# NON-AUTOTROPHIC UPTAKE = Equilibrium nitrate * K
# TOTAL UPTAKE = U + (Equilibrium nitrate * K)  
# Since U_auto is very small, there won't be much difference between 'non-autotrophic uptake' and 'total uptake'

daily_output_cari.df <- daily_output_cari.df %>%
  mutate(U_het = N_e*K*z,      
         U_tot = U_het + U, 
         U_auto_perc = 100*U/U_tot)

U_auto_avg <- mean(daily_output_cari.df$U_auto_perc) #10.3% on average

Uauto_perc_cari <- plot_autoUperc(data=daily_output_cari.df, plot_title = "Daily  autotrophic uptake (as % of total uptake), Caribou Creek, AK")

# quartz()
Uauto_perc_cari 

#### Interactive w. ggplotly, but only gives the x,y info... maybe if I added datetime-associated labels?
# ggplotly(Uauto_plot_cari)

```



#### CUPE
Outputs and visualizations for Rio Cupeyes, San German Municipio, PR



#### WLOU
Ouptuts and visualizations for West St Louis Creek, Grand, CO

###### Load model fits and data
```{r load WLOU model fit and data}
#| output: false
#| message: false

###### Load model fit __________________________________________________________

wlou.fit <- readRDS(here("N_uptake_NEON/data/model_fits/wlou.fit.rds"))

# if working from model run
# wlou.fit <- fit.wlou


###### Load model data ________________________________________________________

# data from model

wlou.modeldata <- readRDS(here("N_uptake_NEON/data/model_datalist/wlou.data.rds"))

###### Load dataset (includes datatime info, which model data does not) _______

# full dataset
path <- here("N_uptake_NEON/data/neon_data_clean/wlou_clean.csv")
wlou.df <- read_csv(path) %>%
  mutate(local_datetime = with_tz(local_datetime, tzone="US/Mountain"), 
         model_datetime = local_datetime - hours(4))  


# hourly dataset
path_h <- here("N_uptake_NEON/data/neon_data_clean/wlou_hourly_clean.csv")
wlou.df.h <- read_csv(path_h) %>%
  mutate(local_datetime = with_tz(local_datetime, tzone="US/Mountain"), 
         model_datetime = local_datetime - hours(4))  
  
  
```

###### Extract model parameters and real-data values

First, check the fit for sigmas and betas ("sigma", "sigma_U", "b0", "b1"), since these are notoriously tough to fit. Then put the spread and mean/ median/ quartile info for K, U, and N_e into a WLOU tibble (to be saved in one large csv at the end of the document). Finally, assemble tibbles for the visualizations, which include both modeled parameters and real data. 

```{r - wlou: extract obs. error model params and real-data values}
##| echo: false

# get list of variables for the model fit
# get_variables(wlou.fit) - too many to see all, but informs re: structure [hour,day] for hourly variables

###### Check the fit for sigmas and betas (tough to fit): ______________________
print(wlou.fit, pars=c("sigma", "sigma_U", "b0", "b1"))

###### Summarize daily variables (K, U, N_e) ___________________________________

# First, use spread_draws for the daily parameters - this gives each parameter its own column
# d = days (198), chain = 4, iteration = 1K, draw = 4K (1 per iteration per chain)
wlou.spread <- spread_draws(wlou.fit, K[d], U[d], N_e[d]) 


# Then get the mean/median + 95% QI (CI) for each parameter/day

### median + CI
wlou.medqi <- wlou.spread %>%
  # dplyr::group_by(d) %>%  # Unnecessary: tidybayes automatically groups by the selected spread_draws group [in this case, 'd']
  median_qi() %>%
  # summarise_draws() %>%
  # pivot_wider(names_from = variable, values_from = mean, median, sd, mad, q5, q95, rhat, ess_bulk, ess_tail) %>%
  add_column(site = "WLOU")

### mean + QI
wlou.meanqi <- wlou.spread %>%
  mean_qi() %>%
  add_column(site = "WLOU")

### Add median param info to the meanqi df
wlou.meanqi$K.median <- wlou.medqi$K
wlou.meanqi$U.median <- wlou.medqi$U
wlou.meanqi$N_e.median <- wlou.medqi$N_e



### Save the daily output + quantiles

### tried the 'summarise_draws()' fcn but couldn't get it to pivot_wider() and make each variable its own column... So, good for checking all 'values_from' columns listed below, but not super useful for plotting etc. 

# wlou.spreadsummary <- wlou.spread %>%
#   summarise_draws() %>%
#   #### pivot_wider(names_from = variable, values_from = mean, median, sd, mad, q5, q95, rhat, ess_bulk, ess_tail) %>%  # DOESN'T WORK HERE
#   add_column(site = "WLOU")
#   
# View(wlou.spreadsummary)


### Summarize hourly variable (conc_pred)

wlou.spread.h <- spread_draws(wlou.fit, conc_pred[h,d])
# View(wlou.spread.h)


wlou.meanqi.h <- wlou.spread.h %>%
  dplyr::group_by(d, h) %>%  # This command IS needed here: tidybayes *did* have h + d column outputs, but the values were both different and less precise than when grouping by (d, h). 
  mean_qi() %>%
  add_column(site = "WLOU")


####### FROM REAL DATA --------------------------------------------

nday_wlou <- wlou.modeldata$D

concMA_wlou <- wlou.modeldata$concMA

# change no3 data from a matrix (concMA) w. column names V1, V2...V[nday] to a vector w. numeric day indices (1, 2, ...198).  Remove "V"?  

N_obs <- as.vector(concMA_wlou)

local_datetime_wlou <- wlou.df.h$local_datetime 
# local_date_wlou <- unique(date(wlou.df.h$local_datetime))  # not quite there w. extracting dates from the hourly data
# model_date_wlou <- wlou.df$model_datetime # nope, this is the FULL 15-min dataset 
model_datetime_wlou <- wlou.df.h$local_datetime - hours(4)
# model_jday_wlou <-wlou.df.h$model_jday
model_yrjday_wlou <- wlou.df.h$yr_jday  # hourly data
mod_yrjday_wlou <- unique(wlou.df.h$yr_jday) # daily data
# hours_wlou <- hour(local_datetime_wlou)
# mod_hours_wlou <- hour(model_datetime_wlou)


####### LOAD DEPTH #################################
zMA <- wlou.modeldata$zMA
#z.daily <- apply(zMA, MARGIN = 2, FUN = mean) ##this wouldn't knit in Quarto, IDK why not

####### LOAD REAL DAILY SUMLIGHT ###################
sumlight.real_wlou <- wlou.modeldata$sumlightReal
sumlight.ideal_wlou <- wlou.modeldata$sumlightIdeal

###################  Compile dataframes _________________________________________

####### Hourly dataframe: N and N_pred #############

N_output_wlou.df <- wlou.df.h %>%  # change to the medqi.h file! then add as needed
  select(local_datetime, model_datetime, surfWaterNitrateMean, GHI_wm2, Year, yr_jday, Jday, model_jday) %>%
  rename(N_conc = surfWaterNitrateMean, 
         realLight_wm2 = GHI_wm2) %>%
  mutate(hours = hour(local_datetime), 
         mod_hours = hour(model_datetime))
  
N_output_wlou.df$N_conc_pred <- wlou.meanqi.h$conc_pred
N_output_wlou.df$z <- as.vector(zMA) #average daily depth


####### Daily dataframe: U, K, N_e ##################

daily_output_wlou.df <- wlou.meanqi %>%
  add_column(sumlightReal = sumlight.real_wlou, 
             sumlightIdeal = sumlight.ideal_wlou, 
             z = colMeans(zMA), # daily depth = average of hourly depth
             yr_jday = mod_yrjday_wlou)  # the daily yr_jday object

mean(daily_output_wlou.df$K) # 3.225407
mean(daily_output_wlou.df$U) # 0.1986689
mean(daily_output_wlou.df$N_e) # 3.395281



```


###### Create visualizations - West St. Louis Creek, CO

```{r - wlou: create visualizations}
#| echo: true

############  N Model fit to data _____________________________________________

######  N model fit over time  #######

# N_and_Npred_wlou <- N_output_wlou.df %>%
#   #group_by(year(model_datetime_wlou)) %>%
#   filter(model_jday >= 35 & model_jday <= 60) %>%  # to see the little boxes better...
#   ggplot(aes(x=mod_hours)) +
#   geom_point(aes(y=N_conc)) + 
#   geom_line(aes(y=N_conc_pred), col='red')+
#   labs(
#     x="Time (h)", y=expression("N"~(mmol~m^-3))
#   ) +
#   ggtitle("NEON: West St. Louis Creek N data + model predictions") +
#   facet_wrap(~yr_jday) +
#   theme_bw()

N_Npred_ts_wlou <- plot_Nmodelfit_ts(data=N_output_wlou.df, start_jday = 35, end_jday = 60, plot_title = "NEON N data + model predictions: West St. Louis Creek, CO ")

#quartz(width=6,height=6)
N_Npred_ts_wlou


######  N-pred vs N  #######

# Npred_v_N_wlou <- ggplot(data = N_output_wlou.df, aes(x=N_conc, y=N_conc_pred)) +
#   geom_point() + 
#   labs( x=expression("measured N"~(mu*mol~L^-1)), # fcn changed both to mmol~m^-3
#         y=expression("modeled N"~(mu*mol~L^-1))  # ~ = a space, * = no space
#       ) + 
#   ggtitle("Measured N vs predicted N, West St. Louis Creek, CO") +
#   geom_abline(intercept = 0, slope = 1, color = "red") + 
#   theme_bw()

Npred_v_N_wlou <- plot_Npred_v_Nobs(data=N_output_wlou.df, plot_title="Measured N vs predicted N, West St. Louis Creek, CO")

#quartz(width=6, height=6)
Npred_v_N_wlou

###### Equifinality checks __________________________________________________

####### Check equifinality!! K vs U

# KvU_wlou <- ggplot(data=daily_output_wlou.df, aes(y=K_mod_avg_wlou, x=U_mod_avg_wlou)) +
#   geom_point() + 
#   labs(y=expression("modeled K"~(d^-1)),
#        x=expression("modeled U"~(mmol~m^-2~d^-1))
#         ) + 
#   ggtitle("Equifinality check, West St. Louis Creek, CO: modeled K vs modeled U") + 
#   # geom_abline(intercept = 0, slope = 1, color = "red") + # doesn't show up - off the charts!
#   theme_bw()


KvU_wlou <- plot_KvU(data=daily_output_wlou.df, plot_title = "Equifinality check, West St. Louis Creek, CO: modeled K vs modeled U")

  
#quartz(width=7.5, height=6)
KvU_wlou
  

####### Check equifinality!! K vs N_e  

# KvNe_wlou <- ggplot(data=daily_output_wlou.df, aes(y=K, x=N_e)) +
#    geom_point() + 
#    labs(y=expression("modeled K"~(d^-1)),
#         x=expression("modeled N_e"~(mmol~m^-3)) 
#         ) + 
#    ggtitle("Equifinality check, West St. Louis Creek, CO: modeled K vs modeled equilibrium N") + 
#    # geom_abline(intercept = 0, slope = 1, color = "red") + # doesn't show up - off the charts!
#   theme_bw()


KvNe_wlou <- plot_KvNe(data=daily_output_wlou.df, plot_title = "Equifinality check, West St. Louis Creek, CO: modeled K vs modeled equilibrium N")

#quartz(width=7.5, height=6)
KvNe_wlou


####### Check equifinality!! U vs N_e  

# UvNe_wlou <- ggplot(data=daily_output_wlou.df, aes(y=U, x=N_e)) +
#    geom_point() + 
#    labs(y=expression("modeled U"~(mmol~m^-2~d^-1)),
#         x=expression("modeled N_e"~(mmol~m^-3)) 
#         ) + 
#    ggtitle("Equifinality check, West St. Louis Creek, CO: modeled U vs modeled equilibrium N") + 
#   theme_bw()

UvNe_wlou <- plot_UvNe(data=daily_output_wlou.df, plot_title = "Equifinality check, West St. Louis Creek, CO: modeled U vs modeled equilibrium N")
 
#quartz(width=7.5, height=6)
UvNe_wlou



#######  K over time

# K_v_time_wlou <- ggplot(data = daily_output_wlou.df, aes(x=d, y=K)) +
#   geom_point() + 
#   # geom_point(y = sumlight.real, color = 'gold') +
#   # ADD IN HIGH AND LOW CIs
#   # xlab("Julian day") + ylab("modeled K (day -1)") + # daily change in N concentration
#   labs( x= "Index", 
#         y=expression("modeled K"~(d^-1)) # ~ = a space, * = no space
#       ) + 
#   #ylim(0,20) +
#   ggtitle("modeled K over time, West St. Louis Creek, CO") +
#   theme_bw()


K_v_time_wlou <- plot_K_ts(data=daily_output_wlou.df, plot_title = "modeled K over time, West St. Louis Creek, CO")

#quartz(width=6.5, height=6)
K_v_time_wlou

##### to clip: no function yet
# K_time_clip_wlou <- ggplot(data = daily_output_wlou.df, aes(x=mod_day_wlou, y=K_mod_avg_wlou)) +
#   geom_point() + 
#   # geom_point(y = sumlight.real, color = 'gold') +
#   # ADD IN HIGH AND LOW CIs
#   xlab("Julian day") + ylab("modeled K (day -1)") + # ??? UNITS?
#   ylim(0,10) +
#   ggtitle("modeled K over time, West St. Louis Creek, CO - ylim = 0,10") +
#   theme_bw()
# 
# quartz()
# K_time_clip_wlou



##### U over time

# U_time_wlou <- ggplot(data = daily_output_wlou.df, aes(x=d, y=U)) +
#   geom_point() + 
#   # geom_point(y = sumlight.real_wlou, color = 'gold') +
#   # ADD IN HIGH AND LOW CIs
#   #xlab("Julian day") + ylab("modeled U (mmol/m2/day)") + 
#   labs( x= "Index", 
#         y=expression("modeled U"~(mmol~m^-2~d^-1)) # ~ = a space, * = no space
#       ) + 
#   #ylim(0,1) +
#   #ggtitle("modeled U over time, Big Creek 2019 pooled model w real light") +
#   ggtitle("Diel nitrate uptake (modeled), West St. Louis Creek, CO") +
#   theme_bw()

U_time_wlou <- plot_U_ts(data=daily_output_wlou.df, plot_title="Diel nitrate uptake (modeled), West St. Louis Creek, CO")

#quartz(width=6, height=6)
U_time_wlou


# U_time_clip_wlou <- ggplot(data = daily_output_wlou.df, aes(x=mod_day_wlou, y=U_mod_avg_wlou)) +
#    geom_point() +
#    # geom_point(y = sumlight.real, color = 'gold') +
#    # ADD IN HIGH AND LOW CIs
#    xlab("Julian day") + ylab("modeled U (mmol/m2/day)") +
#    ylim(0,1) +
#    ggtitle("modeled U over time, West St. Louis Creek, CO - ylim = 0-1") +
#    theme_bw()
# 
#  quartz()
#  U_time_clip_wlou



###### U vs sumlight

# U_vs_light_wlou <- ggplot(data = daily_output_wlou.df, aes(x=sumlightReal, y=U)) +
#   geom_point() + 
#   #xlab("true light (satellite)") + ylab("modeled U (mmol/m2/day)") +
#   # xlab("light (satellite)") + ylab("modeled U (mmol/m2/day)") +
#   labs( x= "light (satellite)", 
#         y=expression("modeled U"~(mmol~m^-2~d^-1)) # ~ = a space, * = no space
#       ) + 
#   scale_x_log10() + scale_y_log10() + 
#   ggtitle("Scatterplot of NO3 uptake and daily light: West St. Louis Creek, CO") +
#   #ylim = c(-0.2, 1) +
#   theme_bw()

U_vs_light_wlou <- plot_UvLight(data=daily_output_wlou.df, plot_title = "Scatterplot of NO3 uptake and daily light: West St. Louis Creek, CO")

# quartz(width=6.5, height=6)
U_vs_light_wlou


```


###### Compare U_total and U_auto

```{r - wlou: percent autotrophic NO3 uptake}

# NON-AUTOTROPHIC UPTAKE = Equilibrium nitrate * K
# TOTAL UPTAKE = U + (Equilibrium nitrate * K)  
# Since U_auto is very small, there won't be much difference between 'non-autotrophic uptake' and 'total uptake'

daily_output_wlou.df <- daily_output_wlou.df %>%
  mutate(U_het = N_e*K*z,      
         U_tot = U_het + U, 
         U_auto_perc = 100*U/U_tot)


U_auto_avg <- mean(daily_output_wlou.df$U_auto_perc) #10.3% on average

# Uauto_plot_wlou <- ggplot(data=daily_output_wlou.df, aes(x=d, y=U_auto_perc)) +
#   geom_point() + 
#   xlab("Index") + ylab("Percent autotrophic uptake") + 
#   ggtitle("Percent of autotrophic uptake each day, West St. Louis Creek, CO") + 
#   theme_bw()


Uauto_perc_wlou <- plot_autoUperc(data=daily_output_wlou.df, plot_title = "Daily  autotrophic uptake (as % of total uptake), West St. Louis Creek, CO")

# quartz()
Uauto_perc_wlou 

#### Interactive w. ggplotly, but only gives the x,y info... maybe if I added datetime-associated labels?
# ggplotly(Uauto_plot_wlou)


```


### Assemble and save mean, median, 95% QI tibble for all sites

Combine the site tibbles into one large tibble, then save it

```{r - assemble and save mean/med/qi tibble}

#####  Bind then save daily parameters (K, U, N_e)  ____________________________

# daily_summary.df <- bind_rows()
# path <- here()
# saveRDS(daily_summary.df, path)

#####  Bind then save hourly parameters (N_e)  _________________________________

# hourly_summary.df <- bind_rows()
# path2 <- here()
# saveRDS(hourly_summary.df, path2)

#####  Bind then save daily and hourly dataframes? 

# daily df

# hourly df

```

